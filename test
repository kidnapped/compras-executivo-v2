from sqlalchemy import text

def get_empenhos(db, contrato_id: int):
    # Step 1: Get unidade prefix
    unidade_query = text("""
        SELECT COALESCE(codigo, '') || COALESCE(gestao, '') AS unidade_code
        FROM unidades
        WHERE id = 16617
    """)
    usg_gestao = db.execute(unidade_query).scalar()  # Returns single value

    # Step 2: Get empenhos
    empenhos_query = text("""
        SELECT e.id AS empenho_id, e.numero
        FROM empenhos e
        JOIN contratoempenhos ce ON ce.empenho_id = e.id
        WHERE ce.contrato_id = :contrato_id
    """)
    empenhos = db.execute(empenhos_query, {"contrato_id": contrato_id}).fetchall()

    # Step 3: Add prefix in Python
    return [
        {
            "empenho_id": row["empenho_id"],
            "result": f"{usg_gestao}{row['numero']}"
        }
        for row in empenhos
    ]

SELECT id_documento_dar
FROM t_export_wd_deta_orca_fina_dar
WHERE id_documento_ne = :numero_empenho;