{% extends "base.html" %} {% block title %}Encontro de Contas - Compras
Executivo{% endblock %} {% block content %}

<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1>Encontro de Contas</h1>
          <p class="text-muted">
            Sistema de análise e reconciliação de contratos e empenhos
          </p>
        </div>
        <div>
          <button
            id="btn-export-excel"
            class="br-button primary small"
            type="button"
            style="display: none"
            onclick="exportToExcel()"
          >
            <i class="fas fa-file-excel"></i> Exportar
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-12 col-md-4 col-lg-3 p-1">
      <div class="br-card h-100 card-contratos">
        <div class="card-header">
          <div class="d-flex" style="width: 100%">
            <div class="ml-3" style="flex-grow: 1">
              <div class="titulo">
                <img
                  src="/static/images/doc2.png"
                  alt="Ícone"
                  style="height: 36px; margin: 10px 0px -10px 0px"
                />
                Empenhos
              </div>
              <div
                style="border-bottom: 1px solid #ccc; margin: -6px 0px 0px 26px"
              ></div>
              <div class="subtitulo">Total de empenhos desde 2019</div>
            </div>

            <div
              class="ml-auto"
              style="margin: -10px -10px 0px 0px; position: relative"
            >
              <button
                class="br-button circle kpi-dropdown-btn"
                type="button"
                aria-label="Opções de visualização"
                data-dashlane-label="true"
                data-dashlane-rid="de64c6a3f21bc3b5"
                data-dashlane-classification="other"
              >
                <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="card-content" style="padding-top: 8px">
          <div class="valor-principal">804</div>
          <div class="linha">
            <div
              class="dashboard-card-filter clickable"
              data-filter="vigentes"
              tabindex="0"
            >
              <div>Vigentes</div>
              <div class="valor-azul">375</div>
            </div>
            <div class="divider"></div>
            <div
              class="dashboard-card-filter clickable"
              data-filter="finalizados"
              tabindex="0"
            >
              <div>Finalizados</div>
              <div class="valor-azul">429</div>
            </div>
            <div class="divider"></div>
            <div
              class="dashboard-card-filter clickable"
              data-filter="criticos"
              tabindex="0"
            >
              <div>Críticos</div>
              <div class="valor-vermelho">36</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4 col-lg-3 p-1">
      <div class="br-card h-100 card-contratos">
        <div class="card-header">
          <div class="d-flex" style="width: 100%">
            <div class="ml-3" style="flex-grow: 1">
              <div class="titulo">
                <img
                  src="/static/images/doc2.png"
                  alt="Ícone"
                  style="height: 36px; margin: 10px 0px -10px 0px"
                />
                Empenhos
              </div>
              <div
                style="border-bottom: 1px solid #ccc; margin: -6px 0px 0px 26px"
              ></div>
              <div class="subtitulo">Total de empenhos desde 2019</div>
            </div>

            <div
              class="ml-auto"
              style="margin: -10px -10px 0px 0px; position: relative"
            >
              <button
                class="br-button circle kpi-dropdown-btn"
                type="button"
                aria-label="Opções de visualização"
                data-dashlane-label="true"
                data-dashlane-rid="de64c6a3f21bc3b5"
                data-dashlane-classification="other"
              >
                <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="card-content" style="padding-top: 8px">
          <div class="valor-principal">804</div>
          <div class="linha">
            <div
              class="dashboard-card-filter clickable"
              data-filter="vigentes"
              tabindex="0"
            >
              <div>Vigentes</div>
              <div class="valor-azul">375</div>
            </div>
            <div class="divider"></div>
            <div
              class="dashboard-card-filter clickable"
              data-filter="finalizados"
              tabindex="0"
            >
              <div>Finalizados</div>
              <div class="valor-azul">429</div>
            </div>
            <div class="divider"></div>
            <div
              class="dashboard-card-filter clickable"
              data-filter="criticos"
              tabindex="0"
            >
              <div>Críticos</div>
              <div class="valor-vermelho">36</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Últimos Lançamentos Section -->

    <div class="col-12 col-md-4 col-lg-4 p-1">
      <div class="br-card" id="ultimos-lancamentos-container">
        <div class="card-header">
          <div class="d-flex" style="width: 100%">
            <div class="ml-3" style="flex-grow: 1">
              <div class="titulo">
                <img
                  src="/static/images/doc2.png"
                  alt="Ícone"
                  style="height: 36px; margin: 10px 0px -10px 0px"
                />
                Últimos Lançamentos
              </div>
              <div
                style="border-bottom: 1px solid #ccc; margin: -6px 0px 0px 26px"
              ></div>
              <div class="subtitulo">
                Valores financeiro e orçamentário deste contrato
              </div>
            </div>
          </div>
        </div>
        <div class="card-content" style="padding: 0">
          <div class="table-responsive">
            <div class="text-muted">
              <span
                class="br-spinner small"
                role="status"
                aria-label="Carregando"
              ></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-width 12-col chart container above the empenhos list -->
  <div class="col-12 mb-4">
    <div
      id="grafico-financeiro-container"
      style="width: 100%; height: 400px"
    ></div>
  </div>

  <!-- Empenhos Originais Section with Grid Financeiro and Movimentações -->
  <div class="row mb-4 encontro-cards-row">
    <!-- Empenhos Originais - Left side (col-lg-8) -->
    <div class="col-lg-8">
      <div class="br-card" id="empenhos-originais-container">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex" style="width: 100%">
              <div class="ml-3" style="flex-grow: 1">
                <div class="titulo">
                  <img
                    src="/static/images/doc2.png"
                    alt="Ícone"
                    style="height: 36px; margin: 10px 0px -10px 0px"
                  />
                  Empenhos Originais
                </div>
                <div
                  style="
                    border-bottom: 1px solid #ccc;
                    margin: -6px 0px 0px 26px;
                  "
                ></div>
                <div class="subtitulo">
                  Lista numerada de empenhos do contrato
                </div>
              </div>
            </div>
            <div
              class="d-flex align-items-center gap-2"
              style="margin-top: -18px"
            ></div>
          </div>
        </div>
        <div class="card-content" style="padding: 0">
          <div class="table-responsive">
            <table class="br-table table-hover table-striped">
              <thead style="background-color: #f8f8f8">
                <tr>
                  <th style="width: 10px; border: none">#</th>
                  <th style="width: 10px; border: none"></th>
                  <th style="border: none">Empenho</th>
                  <th style="border: none">Data</th>
                  <th style="border: none">Valor</th>
                  <th style="border: none">Orçamentário</th>
                  <th style="border: none">Finanças</th>
                  <th style="border: none">Saldo</th>
                  <th style="border: none">Status</th>
                  <th style="width: 10px; border: none"></th>
                  <th style="width: 10px; border: none"></th>
                </tr>
              </thead>
              <tbody id="empenhos-originais-tbody">
                <!-- Loading state -->
                <tr>
                  <td colspan="13" class="text-center" style="padding: 40px">
                    <div class="text-muted">
                      <i class="fas fa-search fa-2x mb-3"></i>
                      <br />
                      Realize uma busca para visualizar os empenhos originais
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Right side - Grid Financeiro and Movimentações stacked (col-lg-4) -->
    <div class="col-lg-4">
      <div class="encontro-right-column">
        <!-- Grid Numerado Financeiro Section -->
        <div class="mb-4">
          <div class="br-card" id="financeiro-grid-container">
            <div class="card-header">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex" style="width: 100%">
                  <div class="ml-3" style="flex-grow: 1">
                    <div class="titulo">
                      <img
                        src="/static/images/doc2.png"
                        alt="Ícone"
                        style="height: 36px; margin: 10px 0px -10px 0px"
                      />
                      Finanças
                    </div>
                    <div
                      style="
                        border-bottom: 1px solid #ccc;
                        margin: -6px 0px 0px 26px;
                      "
                    ></div>
                    <div class="subtitulo">
                      Pagamentos e movimentações financeiras do contrato
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-content" style="padding: 0">
              <div class="table-responsive">
                <table class="br-table table-hover table-striped">
                  <thead style="background-color: #f8f8f8">
                    <tr>
                      <th style="width: 40px; border: none">#</th>
                      <th style="border: none">Data</th>
                      <th style="border: none">Pagamento</th>
                      <th style="width: 50px; border: none"></th>
                      <th style="border: none">Tipo</th>
                      <th style="border: none">Parcial</th>
                      <th style="border: none">Nominal</th>
                    </tr>
                  </thead>
                  <tbody id="financeiro-grid-tbody">
                    <!-- Loading state -->
                    <tr>
                      <td colspan="8" class="text-center" style="padding: 40px">
                        <div class="text-muted">
                          <i class="fas fa-coins fa-2x mb-3"></i>
                          <br />
                          Dados financeiros carregados automaticamente
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Movimentações Orçamentárias Section -->
        <div>
          <div class="br-card" id="movimentacoes-container">
            <div class="card-header">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex" style="width: 100%">
                  <div class="ml-3" style="flex-grow: 1">
                    <div class="titulo">
                      <img
                        src="/static/images/doc2.png"
                        alt="Ícone"
                        style="height: 36px; margin: 10px 0px -10px 0px"
                      />
                      Orçamentário
                    </div>
                    <div
                      style="
                        border-bottom: 1px solid #ccc;
                        margin: -6px 0px 0px 26px;
                      "
                    ></div>
                    <div class="subtitulo">
                      Lista de movimentações orçamentárias do contrato
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-content" style="padding: 0">
              <div class="table-responsive">
                <table class="br-table table-hover table-striped">
                  <thead style="background-color: #f8f8f8">
                    <tr>
                      <th style="width: 40px; border: none">#</th>
                      <th style="border: none">Data</th>
                      <th style="border: none">Empenho</th>
                      <th style="width: 50px; border: none"></th>
                      <th style="border: none">Espécie</th>
                      <th style="border: none">Valor</th>
                      <th style="width: 50px; border: none"></th>
                    </tr>
                  </thead>
                  <tbody id="movimentacoes-tbody">
                    <!-- Loading state -->
                    <tr>
                      <td colspan="7" class="text-center" style="padding: 40px">
                        <div class="text-muted">
                          <i class="fas fa-exchange-alt fa-2x mb-3"></i>
                          <br />
                          Dados de movimentações carregados automaticamente
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div id="empenhos-results" class="col-6">
    <!-- Results will be displayed here dynamically -->
    <div class="text-center text-muted" style="padding: 60px">
      <i class="fas fa-search fa-3x mb-3"></i>
      <h5>Aguardando Consulta</h5>
    </div>
  </div>
  <!-- The DetalhesEmpenhos functionality is now integrated into encontro-contas.js -->
  <!-- No additional script needed here as it's initialized with the main controller -->
</div>

<script type="module">
  import EncontroContas from "/static/js/encontro/encontro-contas.js";
</script>

<!-- Include SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

{% endblock %}
